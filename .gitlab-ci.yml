image: registry.gitlab.cobalt.rocks/cobalt/docker-builder/coderdojo-koneko-builder:latest

stages:
  - Testing
  - Deploy

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - /store
    - build

Lint:
  stage: Testing
  rules:
    - changes:
        - vite.config.js
        - .gitlab-ci.yml
        - prettier.config.js
        - "src/*"
        - "src/*/*"
        - "src/*/*/*"
        - mdsvex.config.js
        - package.json
        - postcss.config.cjs
        - svelte.config.js
        - tailwind.config.cjs
        - tsconfig.json
    - if: $CI_COMMIT_BRANCH != 'koneko'
      when: never
    - when: always
  before_script:
    - pnpm i --frozen-lockfile
  script:
    - pnpm lint

.template: &rs-deploy
  rules:
    - changes:
        - .gitlab-ci.yml
        - "src/*"
        - "src/*/*"
        - "src/*/*/*"
        - "static/*"
        - "static/*/*"
        - "static/*/*/*"
        - mdsvex.config.js
        - package.json
        - pnpm-lock.yaml
        - postcss.config.cjs
        - svelte.config.js
        - tailwind.config.cjs
        - tsconfig.json
        - vite.config.js
    - if: $CI_COMMIT_BRANCH != 'koneko'
      when: never
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - when: always

  before_script:
    # Install all yarn dependencies (normally cached but clover#2 currently has (since 2 years) problems with space)
    - pnpm i --frozen-lockfile
    # Add shh folder
    - mkdir -p ~/.ssh
    # Start ssh agent
    - eval $(ssh-agent -s)
    # Dump keys from CI variables to files
    - echo "$KEY" > ~/.ssh/id_rsa
    - echo "$CD_HOST_KEY" >> ~/.ssh/known_hosts
    # SSH agent requires specific permissions
    - chmod 644 ~/.ssh/known_hosts
    - chmod 700 ~/.ssh
    - chmod 600 ~/.ssh/id_rsa
  script:
    - pnpm build
    - pnpm minify
  after_script:
    # Restart agent - Not necessary for prod only needed for debugging
    # - PID=$(eval "$(ssh-agent -s)" | sed "s/[A-Za-z ]*//") kill -9 "$PID"
    # Upload
    - rsync -e "ssh -p $CD_DIST_PORT -i ~/.ssh/id_rsa" -PL -rvzuc
      --delete  ./build/*  "$CD_DIST_USER@$CD_DIST_HOST:"

CD:Red-Alternate:
  <<: *rs-deploy
  stage: Deploy
  environment:
    name: production-1-v2
    url: https://v2.coderdojo.red
  variables:
    DOMAIN: v2.coderdojo.red
    KEY: "$CD_RED_V2_PRIVATE_KEY"
    PRODUCTION: 1

CD:Blue-Alternate:
  <<: *rs-deploy
  stage: Deploy
  environment:
    name: production-2-v2
    url: https://v2.coderdojo.blue
  variables:
    DOMAIN: v2.coderdojo.blue
    KEY: "$CD_BLUE_V2_PRIVATE_KEY"
    PRODUCTION: 1
