image: registry.gitlab.cobalt.rocks/cobalt/docker-builder/coderdojo-zola-builder:latest

cache:
    key: '${CI_COMMIT_REF_SLUG}'
    paths:
        - node_modules
        - public

Lint:
    only:
        changes:
            - content/*/**
            - content/*
            - themes/*
            - themes/**/*
            - helper/*
            - scaffolds/*/**
            - scaffolds/*
            - _config.yaml
            - postcss.config.js
            - .prettierrc.toml
            - package.json
            - tailwind.config.js
            - yarn.lock
            - .gitlab-ci.yml
    before_script:
        - yarn install --non-interactive --check-files  --frozen-lockfile
    script:
        - yarn ci:lint

.template: &rs-deploy
    only:
        changes:
            - content/*/**
            - content/*
            - themes/*
            - themes/**/*
            - helper/*
            - '_config.yaml'
            - package.json
            - 'tailwind.config.js'
            - 'postcss.config.js'
            - 'yarn.lock'
            - .gitlab-ci.yml
        refs:
            - v2
    before_script:
        # Install all yarn dependencies (normally cached but clover#2 currently has problems with space)
        - yarn install --non-interactive --check-files --frozen-lockfile
        # Add shh folder
        - mkdir -p ~/.ssh
        # Start ssh agent
        - eval $(ssh-agent -s)
        # Dump keys from CI variables to files
        - echo "$KEY" > ~/.ssh/id_rsa
        - echo "$CD_HOST_KEY" >> ~/.ssh/known_hosts
        # SSH agent requires specific permissions
        - chmod 644 ~/.ssh/known_hosts
        - chmod 700 ~/.ssh
        - chmod 600 ~/.ssh/id_rsa
    script:
        - yarn ci:build
    after_script:
        # Restart agent - Not necessary for prod only needed for debugging
        # - PID=$(eval "$(ssh-agent -s)" | sed "s/[A-Za-z ]*//") kill -9 "$PID"
        # Upload
        - rsync -e "ssh -p $CD_DIST_PORT -i ~/.ssh/id_rsa" -PL -rvzuc
          --delete  ./public/*  "$CD_DIST_USER@$CD_DIST_HOST:"

CD:Red-Alternate:
    <<: *rs-deploy
    stage: deploy
    environment:
        name: production-1-v2
        url: https://v2.coderdojo.red
    variables:
        DOMAIN: v2.coderdojo.red
        KEY: '$CD_RED_V2_PRIVATE_KEY'
        PRODUCTION: 1

CD:Blue-Alternate:
    <<: *rs-deploy
    stage: deploy
    environment:
        name: production-2-v2
        url: https://v2.coderdojo.blue
    variables:
        DOMAIN: v2.coderdojo.blue
        KEY: '$CD_BLUE_V2_PRIVATE_KEY'
        PRODUCTION: 1
