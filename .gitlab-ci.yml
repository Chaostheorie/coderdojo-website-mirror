image: registry.gitlab.cobalt.rocks/cobalt/docker-builder/coderdojo-koneko-builder:latest

stages:
  - Testing
  - Deploy

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - /store
    - build

Lint:
  stage: Testing
  rules:
    - changes:
        - vite.config.js
        - .gitlab-ci.yml
        - prettier.config.js
        - "src/*"
        - "src/*/*"
        - "src/*/*/*"
        - mdsvex.config.js
        - package.json
        - postcss.config.cjs
        - svelte.config.js
        - tailwind.config.cjs
        - tsconfig.json
  before_script:
    - pnpm i --frozen-lockfile
  script:
    - pnpm lint

.template: &rs-deploy # NOTE: helium is the only runner allowed to access the coderdojo ssh repos
  tags:
    - helium
  rules:
    - changes:
        - .gitlab-ci.yml
        - "src/*"
        - "src/*/*"
        - "src/*/*/*"
        - "static/*"
        - "static/*/*"
        - "static/*/*/*"
        - mdsvex.config.js
        - package.json
        - pnpm-lock.yaml
        - postcss.config.cjs
        - svelte.config.js
        - tailwind.config.cjs
        - tsconfig.json
        - vite.config.js
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

  before_script:
    # Install all yarn dependencies (normally cached but clover#2 currently has (since 2 years) problems with space)
    - pnpm i --frozen-lockfile
    # Add shh folder
    - mkdir -p ~/.ssh
    # Start ssh agent
    - eval $(ssh-agent -s)
    # Dump keys from CI variables to files
    - echo "$KEY" > ~/.ssh/id_rsa
    - echo "$KEY" | sha256sum
    - echo "$CD_HOST_KEY" >> ~/.ssh/known_hosts
    # SSH agent requires specific permissions
    - chmod 644 ~/.ssh/known_hosts
    - chmod 700 ~/.ssh
    - chmod 600 ~/.ssh/id_rsa
  script:
    - sha256sum ~/.ssh/id_rsa
    - pnpm build
    - pnpm minify
    - rsync -e "ssh -vv -p $CD_DIST_PORT -i ~/.ssh/id_rsa" -PL -rvzuc --delete  ./build/*  "$CD_DIST_USER@$CD_DIST_HOST:"

CD:Red:
  <<: *rs-deploy
  stage: Deploy
  environment:
    name: production-1
    url: https://coderdojo.red
  variables:
    DOMAIN: coderdojo.red
    KEY: "$CD_RED_PRIVATE_KEY"
    PRODUCTION: 1

CD:Blue:
  <<: *rs-deploy
  stage: Deploy
  environment:
    name: production-2
    url: https://coderdojo.blue
  variables:
    DOMAIN: coderdojo.blue
    KEY: "$CD_BLUE_PRIVATE_KEY"
    PRODUCTION: 1
