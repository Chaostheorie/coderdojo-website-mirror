image: registry.gitlab.cobalt.rocks/cobalt/docker-builder/zola-builder:latest

cache:
    key: '${CI_COMMIT_REF_SLUG}'
    paths:
        - node_modules

Lint:
    only:
        changes:
            - sass/*
            - ts/*
            - package.json
            - .stylelintrc.json
            - .eslintrc.json
    before_script:
        - yarn install
    script:
        - yarn run lint

.template: &rs-deploy
    only:
        changes:
            - content/*/**
            - chapter.toml
            - content/*
            - templates/*
            - templates/**/*
            - static/*/**
            - static/*
            - sass/*
            - ts/*
            - config.toml
            - package.json
            - purgecss.config.js
            - webpack.config.js
            - webpack.prod.config.js
            - .gitlab-ci.yml
        refs:
            - main
    before_script:
            # Install all yarn dependencies (normally cached but clover#2 currently has problems with space)
            - yarn install
            # Add shh folder
            - mkdir -p ~/.ssh
            # Start ssh agent
            - eval $(ssh-agent -s)
            # Dump keys from CI variables to files
            - echo "$KEY" > ~/.ssh/id_rsa
            - echo "$CD_HOST_KEY" >> ~/.ssh/known_hosts
            # SSH agent requires specific permissions
            - chmod 644 ~/.ssh/known_hosts
            - chmod 700 ~/.ssh
            - chmod 600 ~/.ssh/id_rsa
    script:
        - yarn run domain
        - yarn run ci-build
    after_script:
        # Restart agent - Not necessary only for debugging
        # - PID=$(eval "$(ssh-agent -s)" | sed "s/[A-Za-z ]*//") kill -9 "$PID"
        # Upload
        - rsync -e "ssh -p $CD_DIST_PORT -i ~/.ssh/id_rsa" -PL -rvzuc --delete  ./public/*  "$CD_DIST_USER@$CD_DIST_HOST:"

CD:Red:
    <<: *rs-deploy
    stage: deploy
    environment:
        name: production#1
        url: https://coderdojo.red
    variables:
        DOMAIN: coderdojo.red
        KEY: "$CD_RED_PRIVATE_KEY"
    
CD:Blue:
    <<: *rs-deploy
    stage: deploy
    environment:
        name: production#2
        url: https://coderdojo.blue
    variables:
        DOMAIN: coderdojo.blue
        KEY: "$CD_RED_PRIVATE_KEY"
    
CD:Rocks:
    <<: *rs-deploy
    stage: deploy
    environment:
        name: secondary
        url: https://coderdojo.cobalt.rocks
    variables:
        DOMAIN: coderdojo.cobalt.rocks
        KEY: "$CD_PRIVATE_KEY"
